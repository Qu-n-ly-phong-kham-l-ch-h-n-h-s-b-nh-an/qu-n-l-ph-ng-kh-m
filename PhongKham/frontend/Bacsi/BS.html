<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard B√°c sƒ©</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <style>
        body { font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 3px;}
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        .status-badge {
            padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem;
            font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;
        }
    </style>
</head>

<body class="bg-slate-100 min-h-screen">
    <div class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        <div class="bg-white p-6 sm:p-8 rounded-xl shadow-lg">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
                <h1 id="doctor-welcome" class="text-3xl font-bold text-slate-800">üóìÔ∏è L·ªãch h·∫πn c·ªßa t√¥i</h1>
                <div class="flex items-center gap-3 mt-4 sm:mt-0">
                     <button id="addAppointmentBtn" class="flex items-center gap-2 bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700 transition-colors duration-300">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                        T·∫°o L·ªãch H·∫πn
                    </button>
                    <button id="logoutBtn" class="flex items-center gap-2 bg-red-500 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-red-700 transition-colors duration-300">
                        ƒêƒÉng xu·∫•t
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div class="relative">
                    <input id="searchPatientName" type="text" placeholder="T√¨m theo t√™n b·ªánh nh√¢n..." class="w-full border border-slate-300 p-2 pl-10 rounded-lg focus:ring-2 focus:ring-indigo-500 transition" />
                     <svg class="w-5 h-5 text-slate-400 absolute top-1/2 left-3 -translate-y-1/2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                </div>
                <select id="statusFilter" class="w-full border border-slate-300 p-2 rounded-lg focus:ring-2 focus:ring-indigo-500 transition">
                    <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
                    <option value="Ch·ªù x√°c nh·∫≠n">Ch·ªù x√°c nh·∫≠n</option>
                    <option value="ƒê√£ x√°c nh·∫≠n">ƒê√£ x√°c nh·∫≠n</option>
                    <option value="ƒêang kh√°m">ƒêang kh√°m</option>
                    <option value="ƒê√£ ho√†n t·∫•t">ƒê√£ ho√†n t·∫•t</option>
                    <option value="ƒê√£ h·ªßy">ƒê√£ h·ªßy</option>
                </select>
            </div>

            <div class="overflow-x-auto rounded-lg border border-slate-200">
                <table class="min-w-full divide-y divide-slate-200">
                    <thead class="bg-slate-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase">B·ªánh nh√¢n</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase">Ng√†y & Gi·ªù h·∫πn</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase">Tr·∫°ng th√°i</th>
                            <th class="px-6 py-3 text-center text-xs font-medium text-slate-500 uppercase">H√†nh ƒë·ªông</th>
                        </tr>
                    </thead>
                    <tbody id="appointmentTableBody" class="bg-white divide-y divide-slate-200"></tbody>
                </table>
            </div>
        </div>
    </div>
    
    <div id="appointmentModal" class="fixed inset-0 bg-black/60 hidden flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-xl w-full max-w-lg shadow-2xl">
            <h2 class="text-2xl font-bold text-slate-800 mb-6">T·∫°o L·ªãch H·∫πn M·ªõi</h2>
            <div class="space-y-4">
                 <div>
                    <label for="patientSelect" class="block text-sm font-medium text-slate-700 mb-1">Ch·ªçn B·ªánh nh√¢n</label>
                    <select id="patientSelect" class="w-full border border-slate-300 p-2 rounded-lg focus:ring-2 focus:ring-indigo-500"></select>
                </div>
                <div>
                    <label for="appointmentDate" class="block text-sm font-medium text-slate-700 mb-1">Ch·ªçn Ng√†y & Gi·ªù h·∫πn</label>
                    <input id="appointmentDate" type="datetime-local" class="w-full border border-slate-300 p-2 rounded-lg focus:ring-2 focus:ring-indigo-500" />
                </div>
            </div>
            <div class="flex justify-end gap-4 mt-8">
                <button id="cancelAppointment" class="bg-slate-200 text-slate-800 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300">H·ªßy</button>
                <button id="saveAppointment" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700">L∆∞u L·ªãch H·∫πn</button>
            </div>
        </div>
    </div>

    <div id="toast-container" class="fixed bottom-5 right-5 z-50 space-y-3"></div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const apiBase = "http://localhost:5236/api";
    const token = localStorage.getItem("token");
    const doctorId = localStorage.getItem("doctorId");
    const doctorName = localStorage.getItem("doctorName");
    const headers = { "Authorization": `Bearer ${token}`, "Content-Type": "application/json" };
    let allAppointments = [];

    const tbody = document.getElementById("appointmentTableBody");
    const appointmentModal = document.getElementById("appointmentModal");

    // --- UTILS ---
    const showToast = (message, type = 'success') => {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        const colors = { success: 'bg-green-500', error: 'bg-red-500', info: 'bg-blue-500' };
        toast.className = `text-white px-6 py-3 rounded-lg shadow-lg transform translate-x-full opacity-0 transition-all duration-500 ${colors[type]}`;
        toast.textContent = message;
        container.appendChild(toast);
        setTimeout(() => toast.classList.remove('translate-x-full', 'opacity-0'), 10);
        setTimeout(() => {
            toast.classList.add('translate-x-full', 'opacity-0');
            toast.addEventListener('transitionend', () => toast.remove());
        }, 3000);
    };

    const formatDate = (dateString) => new Date(dateString).toLocaleString('vi-VN');
    const getStatusBadge = (status) => {
        const map = {
            "Ch·ªù x√°c nh·∫≠n": "bg-yellow-100 text-yellow-800",
            "ƒê√£ x√°c nh·∫≠n": "bg-blue-100 text-blue-800",
            "ƒêang kh√°m": "bg-indigo-100 text-indigo-800",
            "ƒê√£ ho√†n t·∫•t": "bg-green-100 text-green-800",
            "ƒê√£ h·ªßy": "bg-red-100 text-red-800",
        };
        return `<span class="status-badge ${map[status] || 'bg-slate-100'}">${status}</span>`;
    };
    
    // --- AUTH CHECK ---
    if (!token || !doctorId) {
        showToast("Vui l√≤ng ƒëƒÉng nh·∫≠p v·ªõi t√†i kho·∫£n b√°c sƒ©!", "error");
        setTimeout(() => window.location.href = "login.html", 2000);
        return;
    }
    document.getElementById('doctor-welcome').textContent = `üóìÔ∏è L·ªãch h·∫πn c·ªßa B√°c sƒ© ${doctorName || ''}`;

    // --- API & RENDERING ---
    const loadAppointments = async () => {
        tbody.innerHTML = `<tr><td colspan="4" class="text-center p-6 text-slate-500">ƒêang t·∫£i...</td></tr>`;
        try {
            const res = await fetch(`${apiBase}/Appointments/doctor/${doctorId}`, { headers });
            if (!res.ok) throw new Error('Kh√¥ng th·ªÉ t·∫£i l·ªãch h·∫πn.');
            allAppointments = await res.json();
            renderAppointments(allAppointments);
        } catch (error) {
            tbody.innerHTML = `<tr><td colspan="4" class="text-center p-6 text-red-500">${error.message}</td></tr>`;
        }
    };
    
    const renderAppointments = (list) => {
        tbody.innerHTML = "";
        if (list.length === 0) {
            tbody.innerHTML = `<tr><td colspan="4" class="text-center p-6 text-slate-500">Kh√¥ng c√≥ l·ªãch h·∫πn n√†o.</td></tr>`;
            return;
        }
        list.forEach(a => {
            const tr = document.createElement('tr');
            tr.className = "hover:bg-slate-50";
            const canStartExam = a.status === 'ƒê√£ x√°c nh·∫≠n' || a.status === 'ƒêang kh√°m';
            tr.innerHTML = `
                <td class="px-6 py-4 text-sm font-medium text-slate-900">${a.patientName || "‚Äî"}</td>
                <td class="px-6 py-4 text-sm text-slate-600">${formatDate(a.appointmentDate)}</td>
                <td class="px-6 py-4 text-sm">${getStatusBadge(a.status)}</td>
                <td class="px-6 py-4 text-center text-sm">
                    <button data-appointment-id="${a.appointmentId}" 
                            class="start-exam-btn text-white font-bold py-2 px-4 rounded ${canStartExam ? 'bg-green-500 hover:bg-green-600' : 'bg-slate-400 cursor-not-allowed'}"
                            ${!canStartExam ? 'disabled' : ''}>
                        ${a.status === 'ƒêang kh√°m' ? 'Ti·∫øp t·ª•c Kh√°m' : 'B·∫Øt ƒë·∫ßu Kh√°m'}
                    </button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    };

    const handleFilter = () => {
        const patientName = document.getElementById('searchPatientName').value.toLowerCase();
        const status = document.getElementById('statusFilter').value;
        const filtered = allAppointments.filter(a =>
            (a.patientName || '').toLowerCase().includes(patientName) &&
            (!status || a.status === status)
        );
        renderAppointments(filtered);
    };

    // --- MODAL LOGIC ---
    const openAppointmentModal = async () => {
        const patientSelect = document.getElementById('patientSelect');
        try {
            const res = await fetch(`${apiBase}/Patients`, { headers });
            if (!res.ok) throw new Error("Kh√¥ng t·∫£i ƒë∆∞·ª£c danh s√°ch b·ªánh nh√¢n");
            const patients = await res.json();
            patientSelect.innerHTML = '<option value="">-- Ch·ªçn b·ªánh nh√¢n --</option>';
            patients.forEach(p => {
                patientSelect.innerHTML += `<option value="${p.patientId}">${p.fullName} (ID: ${p.patientId})</option>`;
            });
            document.getElementById('appointmentDate').valueAsNumber = new Date().valueOf();
            appointmentModal.classList.remove('hidden');
        } catch (error) {
            showToast(error.message, "error");
        }
    };

    const saveAppointment = async () => {
        const patientId = document.getElementById('patientSelect').value;
        const appointmentDate = document.getElementById('appointmentDate').value;

        if (!patientId || !appointmentDate) {
            showToast("Vui l√≤ng ch·ªçn b·ªánh nh√¢n v√† ng√†y h·∫πn.", "error");
            return;
        }

        const body = {
            patientId: parseInt(patientId),
            doctorId: parseInt(doctorId),
            appointmentDate: new Date(appointmentDate).toISOString()
        };

        try {
            const res = await fetch(`${apiBase}/Appointments/book`, {
                method: 'POST',
                headers,
                body: JSON.stringify(body)
            });
            if (!res.ok) {
                 const errorData = await res.json();
                 throw new Error(errorData.message || 'T·∫°o l·ªãch h·∫πn th·∫•t b·∫°i.');
            }
            showToast("T·∫°o l·ªãch h·∫πn th√†nh c√¥ng! Vui l√≤ng ch·ªù l·ªÖ t√¢n duy·ªát.", "success");
            appointmentModal.classList.add('hidden');
            loadAppointments();
        } catch (error) {
            showToast(error.message, "error");
        }
    };
    
    // --- EVENT LISTENERS ---
    document.getElementById('searchPatientName').addEventListener('input', handleFilter);
    document.getElementById('statusFilter').addEventListener('change', handleFilter);
    document.getElementById('addAppointmentBtn').addEventListener('click', openAppointmentModal);
    document.getElementById('saveAppointment').addEventListener('click', saveAppointment);
    document.getElementById('cancelAppointment').addEventListener('click', () => appointmentModal.classList.add('hidden'));
    document.getElementById('logoutBtn').addEventListener('click', () => {
        localStorage.clear();
        window.location.href = "login.html";
    });

    tbody.addEventListener('click', async (e) => {
        if (e.target.classList.contains('start-exam-btn')) {
            const appointmentId = e.target.dataset.appointmentId;
            try {
                const res = await fetch(`${apiBase}/Encounters/search?appointmentId=${appointmentId}`, { headers });
                if(!res.ok) throw new Error("L·ªói khi t√¨m l·∫ßn kh√°m.");

                const encounters = await res.json();
                const encounter = encounters.find(enc => enc.appointmentId == appointmentId);

                if (encounter && encounter.encounterId) {
                    window.location.href = `kham_benh.html?encounterId=${encounter.encounterId}`;
                } else {
                    showToast("L·ªói: Kh√¥ng t√¨m th·∫•y l·∫ßn kh√°m t∆∞∆°ng ·ª©ng. L·ªãch h·∫πn c√≥ th·ªÉ ch∆∞a ƒë∆∞·ª£c duy·ªát.", "error");
                }
            } catch (error) {
                showToast("Kh√¥ng th·ªÉ b·∫Øt ƒë·∫ßu kh√°m: " + error.message, 'error');
            }
        }
    });

    // --- INITIAL LOAD ---
    loadAppointments();
});
</script>
</body>
</html>