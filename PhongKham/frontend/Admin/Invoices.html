<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üí∞ Qu·∫£n l√Ω H√≥a ƒë∆°n</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <style>
    body { font-family: 'Inter', sans-serif; }
    .btn { padding: 0.5rem 1rem; border-radius: 0.375rem; color: white; font-weight: 600; transition: background-color 0.2s; cursor: pointer; }
    .btn-blue { background-color: #2563eb; }
    .btn-blue:hover { background-color: #1d4ed8; }
    .btn-green { background-color: #16a34a; }
    .btn-green:hover { background-color: #15803d; }
    .btn-red { background-color: #dc2626; }
    .btn-red:hover { background-color: #b91c1c; }
    .btn-gray { background-color: #6b7280; }
    .btn-gray:hover { background-color: #4b5563; }
    /* ‚úÖ CSS cho n√∫t b·ªã v√¥ hi·ªáu h√≥a */
    .btn:disabled { background-color: #9ca3af; cursor: not-allowed; opacity: 0.7; }
    .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); justify-content: center; align-items: center; z-index: 50; }
    .modal.flex { display: flex; }
  </style>
</head>

<body class="bg-gray-100 p-6 min-h-screen">
  <div class="max-w-7xl mx-auto bg-white p-8 rounded-xl shadow-lg">
    <h1 class="text-3xl font-bold text-blue-700 mb-6 border-b pb-4">üí∞ Qu·∫£n l√Ω H√≥a ƒë∆°n</h1>

    <div class="flex flex-wrap gap-4 items-center mb-6">
      <input id="keyword" type="text" placeholder="T√¨m theo t√™n b·ªánh nh√¢n..." class="border p-2 rounded-lg w-full sm:w-60 focus:ring-2 focus:ring-blue-500" />
      <select id="statusFilter" class="border p-2 rounded-lg w-full sm:w-auto focus:ring-2 focus:ring-blue-500">
        <option value="">-- T·∫•t c·∫£ tr·∫°ng th√°i --</option>
        <option value="Ch∆∞a thanh to√°n">Ch∆∞a thanh to√°n</option>
        <option value="ƒê√£ thanh to√°n">ƒê√£ thanh to√°n</option>
        <option value="ƒê√£ h·ªßy">ƒê√£ h·ªßy</option>
      </select>
      <button id="filterBtn" class="btn btn-blue w-full sm:w-auto">T√¨m ki·∫øm</button>
      <div class="sm:ml-auto flex gap-2">
          <button id="addInvoiceBtn" class="btn btn-green">+ Th√™m h√≥a ƒë∆°n</button>
          <button id="exportBtn" class="btn btn-blue">üì§ Xu·∫•t Excel</button>
      </div>
    </div>

    <div class="overflow-x-auto border rounded-lg">
      <table class="min-w-full">
        <thead class="bg-gray-50 text-left">
          <tr>
            <th class="p-3 font-semibold text-gray-600">ID</th>
            <th class="p-3 font-semibold text-gray-600">B·ªánh nh√¢n</th>
            <th class="p-3 font-semibold text-gray-600">T·ªïng ti·ªÅn</th>
            <th class="p-3 font-semibold text-gray-600">Ng√†y thanh to√°n</th>
            <th class="p-3 font-semibold text-gray-600">Ph∆∞∆°ng th·ª©c</th>
            <th class="p-3 font-semibold text-gray-600">Tr·∫°ng th√°i</th>
            <th class="p-3 font-semibold text-gray-600 text-center">H√†nh ƒë·ªông</th>
          </tr>
        </thead>
        <tbody class="divide-y" id="invoiceBody"></tbody>
      </table>
    </div>
  </div>

  <div id="invoiceModal" class="modal">
    <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-lg">
      <h2 id="modalTitle" class="text-xl font-bold mb-4 text-blue-700">Th√™m H√≥a ƒë∆°n</h2>
      <form id="invoiceForm" class="flex flex-col gap-4">
        <input type="hidden" id="invoiceId">
        <div>
            <label for="patientId" class="block text-sm font-medium text-gray-700">B·ªánh nh√¢n</label>
            <select id="patientId" class="border p-2 rounded w-full mt-1" required></select>
        </div>
        <div>
            <label for="encounterId" class="block text-sm font-medium text-gray-700">L·∫ßn kh√°m</label>
            <select id="encounterId" class="border p-2 rounded w-full mt-1" required></select>
        </div>
        <input id="totalAmount" type="number" placeholder="T·ªïng ti·ªÅn (t·ª± ƒë·ªông t√≠nh n·∫øu t·∫°o t·ª´ l·∫ßn kh√°m)" class="border p-2 rounded" />
        <input id="paymentDate" type="date" class="border p-2 rounded" />
        <input id="paymentMethod" placeholder="Ph∆∞∆°ng th·ª©c thanh to√°n" class="border p-2 rounded" />
        <select id="status" class="border p-2 rounded">
          <option value="Ch∆∞a thanh to√°n">Ch∆∞a thanh to√°n</option>
          <option value="ƒê√£ thanh to√°n">ƒê√£ thanh to√°n</option>
          <option value="ƒê√£ h·ªßy">ƒê√£ h·ªßy</option>
        </select>
        <div class="flex justify-end gap-3 mt-4">
          <button type="button" id="cancelModal" class="btn btn-gray">H·ªßy</button>
          <button type="submit" class="btn btn-green">L∆∞u</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const apiBase = "http://localhost:5236/api";
    const token = localStorage.getItem("token");
    const headers = { "Authorization": `Bearer ${token}`, "Content-Type": "application/json" };

    const modal = document.getElementById("invoiceModal");
    const form = document.getElementById("invoiceForm");

    async function loadInvoices() {
        const keyword = document.getElementById('keyword').value;
        const status = document.getElementById('statusFilter').value;
        const url = new URL(`${apiBase}/Invoices/search`);
        if (keyword) url.searchParams.append('keyword', keyword);
        if (status) url.searchParams.append('status', status);

        try {
            const res = await fetch(url, { headers });
            if (!res.ok) throw new Error("T·∫£i danh s√°ch h√≥a ƒë∆°n th·∫•t b·∫°i.");
            const invoices = await res.json();
            renderTable(invoices);
        } catch (error) {
            console.error(error);
            alert(error.message);
        }
    }

    async function saveInvoice(e) {
        e.preventDefault();
        const invoiceId = document.getElementById("invoiceId").value;
        const data = {
            invoiceId: invoiceId ? parseInt(invoiceId) : 0,
            patientId: parseInt(document.getElementById("patientId").value),
            encounterId: parseInt(document.getElementById("encounterId").value),
            totalAmount: parseFloat(document.getElementById("totalAmount").value) || 0,
            paymentDate: document.getElementById("paymentDate").value || new Date().toISOString().split('T')[0],
            paymentMethod: document.getElementById("paymentMethod").value,
            status: document.getElementById("status").value,
        };
        const method = invoiceId ? "PUT" : "POST";
        const url = invoiceId ? `${apiBase}/Invoices/${invoiceId}` : `${apiBase}/Invoices`;
        
        try {
            const res = await fetch(url, { method, headers, body: JSON.stringify(data) });
            if (!res.ok) {
                const errorData = await res.json();
                throw new Error(errorData.message || "L∆∞u th·∫•t b·∫°i.");
            }
            alert(`ƒê√£ ${invoiceId ? 'c·∫≠p nh·∫≠t' : 'th√™m'} h√≥a ƒë∆°n th√†nh c√¥ng!`);
            closeModal();
            loadInvoices();
        } catch(error) {
            console.error(error);
            alert(error.message);
        }
    }

    async function deleteInvoice(id) {
        if (!confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a h√≥a ƒë∆°n #${id}?`)) return;
        try {
            const res = await fetch(`${apiBase}/Invoices/${id}`, { method: 'DELETE', headers });
             if (!res.ok) {
                const errorData = await res.json();
                throw new Error(errorData.message || "X√≥a th·∫•t b·∫°i.");
            }
            alert("ƒê√£ x√≥a h√≥a ƒë∆°n th√†nh c√¥ng!");
            loadInvoices();
        } catch(error) {
            console.error(error);
            alert(error.message);
        }
    }

    async function loadSelects() {
        const patientSelect = document.getElementById('patientId');
        const encounterSelect = document.getElementById('encounterId');
        try {
            const [patientsRes, encountersRes] = await Promise.all([
                fetch(`${apiBase}/Patients`, { headers }),
                fetch(`${apiBase}/Encounters`, { headers })
            ]);
            const patients = await patientsRes.json();
            const encounters = await encountersRes.json();
            patientSelect.innerHTML = '<option value="">-- Ch·ªçn b·ªánh nh√¢n --</option>';
            patients.forEach(p => patientSelect.add(new Option(p.fullName, p.patientId)));
            encounterSelect.innerHTML = '<option value="">-- Ch·ªçn l·∫ßn kh√°m --</option>';
            encounters.forEach(e => encounterSelect.add(new Option(`ID ${e.encounterId} - ${e.patientName}`, e.encounterId)));
        } catch (error) {
            console.error("L·ªói t·∫£i danh s√°ch cho form:", error);
        }
    }

    // ‚úÖ H√ÄM RENDER ƒê√É ƒê∆Ø·ª¢C C·∫¨P NH·∫¨T
    function renderTable(invoices) {
        const tbody = document.getElementById("invoiceBody");
        if (invoices.length === 0) {
            tbody.innerHTML = `<tr><td colspan="7" class="p-4 text-center text-gray-500">Kh√¥ng t√¨m th·∫•y h√≥a ƒë∆°n n√†o.</td></tr>`;
            return;
        }
        tbody.innerHTML = invoices.map(i => {
            const isPaid = i.status === 'ƒê√£ thanh to√°n';
            const disabledAttribute = isPaid ? 'disabled' : '';
            
            return `
                <tr class="hover:bg-gray-50">
                    <td class="p-3 border-b">${i.invoiceId}</td>
                    <td class="p-3 border-b">${i.patientName || 'N/A'}</td>
                    <td class="p-3 border-b">${(i.totalAmount || 0).toLocaleString('vi-VN')} ƒë</td>
                    <td class="p-3 border-b">${i.paymentDate ? new Date(i.paymentDate).toLocaleDateString('vi-VN') : ''}</td>
                    <td class="p-3 border-b">${i.paymentMethod || ''}</td>
                    <td class="p-3 border-b">${i.status || ''}</td>
                    <td class="p-3 border-b text-center">
                        <button class="btn btn-blue text-xs" onclick='openEditModal(${JSON.stringify(i)})' ${disabledAttribute}>C·∫≠p nh·∫≠t</button>
                        <button class="btn btn-red text-xs" onclick='deleteInvoice(${i.invoiceId})' ${disabledAttribute}>X√≥a</button>
                    </td>
                </tr>
            `;
        }).join('');
    }
    
    function openModal() {
        form.reset();
        document.getElementById("invoiceId").value = '';
        document.getElementById("modalTitle").textContent = "Th√™m H√≥a ƒë∆°n m·ªõi";
        loadSelects();
        modal.classList.add("flex");
    }

    // ‚úÖ H√ÄM M·ªû MODAL S·ª¨A ƒê√É ƒê∆Ø·ª¢C C·∫¨P NH·∫¨T
    async function openEditModal(invoice) {
        form.reset();
        await loadSelects(); 
        
        document.getElementById("invoiceId").value = invoice.invoiceId;
        document.getElementById("patientId").value = invoice.patientId;
        document.getElementById("encounterId").value = invoice.encounterId;
        document.getElementById("totalAmount").value = invoice.totalAmount;
        document.getElementById("paymentDate").value = invoice.paymentDate ? invoice.paymentDate.split('T')[0] : '';
        document.getElementById("paymentMethod").value = invoice.paymentMethod;
        document.getElementById("status").value = invoice.status;

        document.getElementById("modalTitle").textContent = `C·∫≠p nh·∫≠t H√≥a ƒë∆°n #${invoice.invoiceId}`;
        modal.classList.add("flex");
    }

    function closeModal() {
        modal.classList.remove("flex");
    }

    document.getElementById("filterBtn").onclick = loadInvoices;
    document.getElementById("addInvoiceBtn").onclick = openModal;
    document.getElementById("cancelModal").onclick = closeModal;
    form.onsubmit = saveInvoice;
    
    document.getElementById("exportBtn").onclick = async () => {
      try {
        const res = await fetch(`${apiBase}/Invoices/export`, { headers });
        if (res.ok) {
            const blob = await res.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `HoaDon_${new Date().toISOString().slice(0,10)}.xlsx`;
            document.body.appendChild(a);
            a.click();
            a.remove();
        } else {
            alert("Xu·∫•t Excel th·∫•t b·∫°i!");
        }
      } catch(error) {
        console.error(error);
        alert("C√≥ l·ªói x·∫£y ra khi xu·∫•t file.");
      }
    };
    
    document.addEventListener('DOMContentLoaded', loadInvoices);
  </script>
</body>
</html>