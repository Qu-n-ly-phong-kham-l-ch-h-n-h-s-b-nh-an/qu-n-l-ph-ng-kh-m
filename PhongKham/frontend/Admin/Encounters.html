<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Qu·∫£n l√Ω L·∫ßn kh√°m - T·∫•t c·∫£ t√†i kho·∫£n</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f8fafc;
    }
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.6rem 1.2rem;
      border-radius: 0.5rem;
      font-weight: 600;
      transition: all 0.2s ease-in-out;
      border: 1px solid transparent;
    }
    .btn-primary { background-color: #3b82f6; color: white; }
    .btn-primary:hover { background-color: #2563eb; transform: translateY(-1px); }
    .btn-secondary { background-color: #f1f5f9; color: #475569; }
    .btn-secondary:hover { background-color: #e2e8f0; }
  </style>
</head>

<body class="bg-slate-100 text-slate-800">
  <div class="container mx-auto p-6">
    <div class="max-w-7xl mx-auto bg-white p-6 rounded-2xl shadow-lg">
      <div class="flex items-center justify-between mb-6 pb-4 border-b border-slate-200">
        <h1 class="text-3xl font-bold text-slate-800 flex items-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M12 4v16m8-8H4" />
          </svg>
          Qu·∫£n l√Ω L·∫ßn kh√°m
        </h1>
        <button id="addEncounterBtn" class="btn btn-primary">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd"
              d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z"
              clip-rule="evenodd" />
          </svg>
          <span>Th√™m l·∫ßn kh√°m</span>
        </button>
      </div>

      <div class="mb-6">
        <input id="searchInput" type="text" placeholder="üîç T√¨m theo b√°c sƒ© ho·∫∑c b·ªánh nh√¢n..."
          class="w-full border border-gray-300 p-2 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" />
      </div>

      <div class="overflow-x-auto border border-gray-200 rounded-lg">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase">ID</th>
              <th class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase">B√°c sƒ©</th>
              <th class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase">B·ªánh nh√¢n</th>
              <th class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase">Ng√†y kh√°m</th>
              <th class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase">Ghi ch√∫</th>
              <th class="px-6 py-3 text-center text-xs font-bold text-gray-600 uppercase">H√†nh ƒë·ªông</th>
            </tr>
          </thead>
          <tbody id="encounterTable" class="bg-white divide-y divide-gray-200"></tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="encounterModal" class="fixed inset-0 bg-black/60 hidden items-center justify-center p-4">
    <div class="bg-white p-6 rounded-2xl w-full max-w-md shadow-xl">
      <h2 id="modalTitle" class="text-2xl font-bold text-gray-800 mb-6"></h2>

      <div class="space-y-4">
        <div>
          <label for="appointmentId" class="block text-sm font-medium text-gray-700 mb-1">Ch·ªçn L·ªãch h·∫πn</label>
          <select id="appointmentId" class="w-full border border-gray-300 rounded-lg p-2">
            <option value="">-- Ch·ªçn l·ªãch h·∫πn --</option>
          </select>
        </div>

        <div>
          <label for="doctorId" class="block text-sm font-medium text-gray-700 mb-1">Ch·ªçn B√°c sƒ©</label>
          <select id="doctorId" class="w-full border border-gray-300 rounded-lg p-2">
            <option value="">-- Ch·ªçn b√°c sƒ© --</option>
          </select>
        </div>

        <textarea id="notes" placeholder="Ghi ch√∫..." rows="3"
          class="w-full border border-gray-300 p-2 rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
      </div>

      <div class="flex justify-end gap-3 mt-8">
        <button id="cancelEncounter" class="btn btn-secondary">H·ªßy</button>
        <button id="saveEncounter" class="btn btn-primary">L∆∞u</button>
      </div>
    </div>
  </div>

  <script>
    const apiBase = "http://localhost:5236/api";
    const token = localStorage.getItem("token");
    const headers = { "Authorization": `Bearer ${token}`, "Content-Type": "application/json" };
    let encounters = [], editingId = null;

    if (!token) {
      alert("Vui l√≤ng ƒëƒÉng nh·∫≠p!");
      window.location.href = "../Login/login.html";
    }

    // --- T·∫£i d·ªØ li·ªáu ---
    async function loadEncounters() {
      try {
        const res = await fetch(`${apiBase}/Encounters`, { headers });
        if (!res.ok) throw new Error("Kh√¥ng th·ªÉ t·∫£i danh s√°ch l·∫ßn kh√°m.");
        encounters = await res.json();
        renderEncounters(encounters);
      } catch (error) {
        console.error(error);
        alert(error.message);
      }
    }

    async function loadSelects() {
      try {
        const [appointmentsRes, doctorsRes] = await Promise.all([
          fetch(`${apiBase}/Appointments`, { headers }),
          fetch(`${apiBase}/Doctors`, { headers })
        ]);

        const appointments = await appointmentsRes.json();
        const doctors = await doctorsRes.json();

        const appointmentSelect = document.getElementById("appointmentId");
        const doctorSelect = document.getElementById("doctorId");

        appointmentSelect.innerHTML = `<option value="">-- Ch·ªçn l·ªãch h·∫πn --</option>`;
        appointments.forEach(a => {
          const option = new Option(`${a.appointmentId} - ${a.patientName || "?"}`, a.appointmentId);
          appointmentSelect.add(option);
        });

        doctorSelect.innerHTML = `<option value="">-- Ch·ªçn b√°c sƒ© --</option>`;
        doctors.forEach(d => {
          const option = new Option(d.fullName, d.doctorId);
          doctorSelect.add(option);
        });
      } catch (error) {
        console.error("L·ªói khi t·∫£i d·ªØ li·ªáu cho select:", error);
        alert("Kh√¥ng th·ªÉ t·∫£i danh s√°ch l·ªãch h·∫πn ho·∫∑c b√°c sƒ©.");
      }
    }

    function renderEncounters(dataToRender) {
      const tbody = document.getElementById("encounterTable");
      tbody.innerHTML = "";

      if (!dataToRender || dataToRender.length === 0) {
        tbody.innerHTML = `<tr><td colspan="6" class="text-center p-4 text-gray-500">Kh√¥ng c√≥ d·ªØ li·ªáu.</td></tr>`;
        return;
      }
      
      dataToRender.forEach(e => {
        const row = document.createElement('tr');
        row.className = "hover:bg-gray-50";
        row.innerHTML = `
          <td class="px-6 py-4 text-sm font-medium text-gray-900">${e.encounterId}</td>
          <td class="px-6 py-4 text-sm text-gray-600">${e.doctorName || ""}</td>
          <td class="px-6 py-4 text-sm text-gray-600">${e.patientName || ""}</td>
          <td class="px-6 py-4 text-sm text-gray-600">${new Date(e.appointmentDate).toLocaleDateString('vi-VN')}</td>
          <td class="px-6 py-4 text-sm text-gray-600">${e.notes || ""}</td>
          <td class="px-6 py-4 text-center text-sm font-medium">
            <button onclick="openEdit(${e.encounterId})" class="text-blue-600 hover:underline mr-3">S·ª≠a</button>
            <button onclick="deleteEncounter(${e.encounterId})" class="text-red-600 hover:underline">X√≥a</button>
          </td>`;
        tbody.appendChild(row);
      });
    }

    // --- Modal ---
    const modal = document.getElementById("encounterModal");
    function openModal(title) {
      document.getElementById("modalTitle").textContent = title;
      modal.classList.remove("hidden");
      modal.classList.add("flex");
      loadSelects();
    }
    function closeModal() {
      modal.classList.add("hidden");
      modal.classList.remove("flex");
      editingId = null;
      document.getElementById("appointmentId").value = "";
      document.getElementById("doctorId").value = "";
      document.getElementById("notes").value = "";
    }

    document.getElementById("addEncounterBtn").onclick = () => {
        openModal("Th√™m L·∫ßn kh√°m m·ªõi");
    }
    document.getElementById("cancelEncounter").onclick = closeModal;

    // --- L∆∞u d·ªØ li·ªáu ---
    document.getElementById("saveEncounter").onclick = async () => {
      // ‚úÖ S·ª¨A L·ªñI 400 T·∫†I ƒê√ÇY
      const data = {
        encounterId: editingId, // Th√™m d√≤ng n√†y ƒë·ªÉ g·ª≠i ID khi c·∫≠p nh·∫≠t
        appointmentId: parseInt(document.getElementById("appointmentId").value),
        doctorId: parseInt(document.getElementById("doctorId").value),
        notes: document.getElementById("notes").value.trim()
      };
      
      if (isNaN(data.appointmentId) || isNaN(data.doctorId)) {
        alert("Vui l√≤ng ch·ªçn ƒë·∫ßy ƒë·ªß l·ªãch h·∫πn v√† b√°c sƒ©.");
        return;
      }

      const method = editingId ? "PUT" : "POST";
      const url = editingId ? `${apiBase}/Encounters/${editingId}` : `${apiBase}/Encounters`;

      try {
        const res = await fetch(url, { method, headers, body: JSON.stringify(data) });
        if (!res.ok) {
          const errorBody = await res.json(); // L·∫•y l·ªói d·∫°ng JSON
          throw new Error(`L·ªói t·ª´ server: ${res.status} - ${errorBody.message}`);
        }
        alert(editingId ? "C·∫≠p nh·∫≠t th√†nh c√¥ng!" : "Th√™m m·ªõi th√†nh c√¥ng!");
        closeModal();
        loadEncounters();
      } catch (error) {
        console.error("L·ªói khi l∆∞u:", error);
        alert(`L·ªói khi l∆∞u d·ªØ li·ªáu. ${error.message}`);
      }
    };

    async function openEdit(id) {
        try {
            const res = await fetch(`${apiBase}/Encounters/${id}`, { headers });
            if (!res.ok) throw new Error("Kh√¥ng t√¨m th·∫•y l·∫ßn kh√°m.");
            const e = await res.json();
            
            editingId = id;
            openModal("Ch·ªânh s·ª≠a L·∫ßn kh√°m");
            
            await loadSelects();
            
            document.getElementById("appointmentId").value = e.appointmentId;
            document.getElementById("doctorId").value = e.doctorId;
            document.getElementById("notes").value = e.notes || "";
        } catch (error) {
            console.error(error);
            alert(error.message);
        }
    }
    
    async function deleteEncounter(id) {
      if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a l·∫ßn kh√°m n√†y?")) return;
      
      try {
        const res = await fetch(`${apiBase}/Encounters/${id}`, { method: "DELETE", headers });
        if (res.status === 204) { // X√≥a th√†nh c√¥ng th∆∞·ªùng tr·∫£ v·ªÅ 204 No Content
          alert("ƒê√£ x√≥a th√†nh c√¥ng!");
          loadEncounters();
        } else {
          const errorBody = await res.json();
          throw new Error(`L·ªói t·ª´ server: ${res.status} - ${errorBody.message}`);
        }
      } catch (error) {
        console.error("L·ªói khi x√≥a:", error);
        alert(`X√≥a th·∫•t b·∫°i. ${error.message}`);
      }
    }

    // --- T√¨m ki·∫øm ---
    document.getElementById("searchInput").addEventListener("input", e => {
      const keyword = e.target.value.toLowerCase();
      const filteredData = encounters.filter(x =>
        (x.doctorName || "").toLowerCase().includes(keyword) ||
        (x.patientName || "").toLowerCase().includes(keyword)
      );
      renderEncounters(filteredData);
    });

    // --- Kh·ªüi ch·∫°y ---
    loadEncounters();
  </script>
</body>
</html>