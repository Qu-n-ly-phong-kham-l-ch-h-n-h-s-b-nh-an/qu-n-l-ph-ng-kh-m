<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Quản lý Tồn kho - Admin</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Inter', sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    /* Animation cho modal */
    #stockModal[data-state="open"] {
        display: flex;
    }
    #stockModal[data-state="open"] > div {
        animation: fadeInScale 0.2s ease-out forwards;
    }
    #stockModal[data-state="closing"] > div {
        animation: fadeOutScale 0.2s ease-in forwards;
    }
    @keyframes fadeInScale {
        from { opacity: 0; transform: scale(0.95); }
        to { opacity: 1; transform: scale(1); }
    }
    @keyframes fadeOutScale {
        from { opacity: 1; transform: scale(1); }
        to { opacity: 0; transform: scale(0.95); }
    }
  </style>
</head>

<body class="bg-slate-50">
  <div class="container mx-auto p-4 sm:p-6 lg:p-8">
    <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-lg transition-shadow duration-300">
      <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center pb-4 mb-6 border-b border-slate-200">
        <div class="flex items-center gap-3">
            <div class="bg-teal-100 p-2 rounded-lg">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-teal-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4M4 7v10" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 11v6" />
                </svg>
            </div>
            <h1 class="text-3xl font-bold text-slate-800">Quản lý Tồn kho</h1>
        </div>
        <button id="addStockBtn" class="mt-4 sm:mt-0 flex items-center justify-center gap-2 w-full sm:w-auto px-5 py-2.5 bg-teal-600 text-white font-semibold rounded-lg shadow-md hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-teal-500 focus:ring-opacity-75 transition-all duration-200 transform hover:scale-105">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
          </svg>
          Thêm tồn kho
        </button>
      </div>

      <div class="flex flex-wrap items-center gap-4 mb-6 p-4 bg-slate-50 rounded-lg">
        <input id="keyword" type="text" placeholder="Tìm tên thuốc..." class="flex-grow min-w-[200px] border-slate-300 rounded-lg shadow-sm transition focus:ring-2 focus:ring-teal-500 focus:border-teal-500" />
        <input id="minQty" type="number" placeholder="SL từ" class="w-28 border-slate-300 rounded-lg shadow-sm transition focus:ring-2 focus:ring-teal-500 focus:border-teal-500" />
        <input id="maxQty" type="number" placeholder="SL đến" class="w-28 border-slate-300 rounded-lg shadow-sm transition focus:ring-2 focus:ring-teal-500 focus:border-teal-500" />
        <button id="filterBtn" class="flex items-center justify-center gap-2 px-5 py-2.5 bg-slate-700 text-white font-semibold rounded-lg shadow-md hover:bg-slate-800 focus:outline-none focus:ring-2 focus:ring-slate-500 focus:ring-opacity-75 transition-all duration-200 transform hover:scale-105">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
          </svg>
          Tìm kiếm
        </button>
      </div>

      <div class="overflow-x-auto rounded-lg border border-slate-200">
        <table class="min-w-full text-sm">
          <thead class="bg-slate-100">
            <tr>
              <th class="px-4 py-3 text-left font-semibold text-slate-600 uppercase tracking-wider">ID</th>
              <th class="px-4 py-3 text-left font-semibold text-slate-600 uppercase tracking-wider">Tên thuốc</th>
              <th class="px-4 py-3 text-left font-semibold text-slate-600 uppercase tracking-wider">Số lượng tồn</th>
              <th class="px-4 py-3 text-left font-semibold text-slate-600 uppercase tracking-wider">Cập nhật cuối</th>
              <th class="px-4 py-3 text-center font-semibold text-slate-600 uppercase tracking-wider">Hành động</th>
            </tr>
          </thead>
          <tbody id="stockTable" class="bg-white"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ✅ Modal thêm/sửa -->
  <div id="stockModal" data-state="closed" class="fixed inset-0 bg-black/60 z-50 items-center justify-center p-4 hidden">
    <div class="bg-white p-6 rounded-xl w-full max-w-md shadow-2xl space-y-4">
      <div class="flex justify-between items-center pb-3 border-b border-slate-200">
        <h2 id="modalTitle" class="text-2xl font-bold text-slate-800"></h2>
        <button onclick="closeModal()" class="text-slate-400 hover:text-slate-600 transition-transform transform hover:rotate-90">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      <div class="space-y-4 pt-2">
        <select id="drugId" class="w-full px-4 py-2.5 border border-slate-300 rounded-lg transition focus:ring-2 focus:ring-teal-500 focus:border-teal-500">
          <option value="">-- Chọn thuốc --</option>
        </select>
        <input id="quantity" type="number" placeholder="Số lượng tồn" class="w-full px-4 py-2.5 border border-slate-300 rounded-lg transition focus:ring-2 focus:ring-teal-500 focus:border-teal-500" />
      </div>
      <div class="flex justify-end gap-3 pt-4">
        <button id="cancelStock" class="px-5 py-2.5 bg-slate-200 text-slate-800 font-semibold rounded-lg hover:bg-slate-300 transition-all duration-200">Hủy</button>
        <button id="saveStock" class="px-5 py-2.5 bg-teal-600 text-white font-semibold rounded-lg shadow-md hover:bg-teal-700 transition-all duration-200">Lưu</button>
      </div>
    </div>
  </div>

  <script>
    const apiBase = "http://localhost:5236/api/DrugStocks";
    const token = localStorage.getItem("token");
    const headers = { "Authorization": `Bearer ${token}`, "Content-Type": "application/json" };
    const stockTableBody = document.getElementById("stockTable");
    const drugSelect = document.getElementById("drugId");

    let stocks = [];
    let editingId = null;

    if (!token) {
      alert("Vui lòng đăng nhập trước!");
      window.location.href = "../Login/login.html?role=Pharmacist";
    }

    window.onload = () => loadStocks();

    function showFeedback(message, isError = false) {
        const color = isError ? 'text-red-500' : 'text-slate-500';
        stockTableBody.innerHTML = `<tr><td colspan="5" class="p-8 text-center ${color}">${message}</td></tr>`;
    }

    async function loadStocks() {
        showFeedback("Đang tải dữ liệu...");
        try {
            const res = await fetch(apiBase, { headers });
            if (!res.ok) throw new Error(`Lỗi ${res.status}: Không thể tải dữ liệu.`);
            stocks = await res.json();
            renderStocks(stocks);
        } catch (error) {
            showFeedback(error.message, true);
        }
    }

    async function loadDrugs() {
      try {
        const res = await fetch("http://localhost:5236/api/Drugs", { headers });
        if (!res.ok) throw new Error("Không thể tải danh sách thuốc.");
        const drugs = await res.json();
        drugSelect.innerHTML = `<option value="">-- Chọn thuốc --</option>`;
        drugs.forEach(d => {
          const opt = document.createElement("option");
          opt.value = d.drugId;
          opt.textContent = `${d.drugName} (ID: ${d.drugId})`;
          drugSelect.appendChild(opt);
        });
      } catch (err) {
        alert("Lỗi tải danh sách thuốc: " + err.message);
      }
    }

    function renderStocks(stocksToRender) {
      stockTableBody.innerHTML = "";
      if (stocksToRender.length === 0) {
        showFeedback("Không tìm thấy dữ liệu tồn kho.");
        return;
      }
      stocksToRender.forEach(s => {
        const lastUpdated = new Date(s.lastUpdated).toLocaleString('vi-VN');
        const row = `
          <tr class="even:bg-slate-50 hover:bg-teal-50/60 transition-colors duration-200 border-b border-slate-200 last:border-b-0">
            <td class="px-4 py-3 text-slate-600">${s.stockId}</td>
            <td class="px-4 py-3 font-medium text-slate-900">${s.drugName || "N/A"}</td>
            <td class="px-4 py-3 text-slate-600 font-semibold">${s.quantityAvailable}</td>
            <td class="px-4 py-3 text-slate-600">${lastUpdated}</td>
            <td class="px-4 py-3 text-center">
              <button onclick="openEditModal(${s.stockId})" class="text-blue-600 hover:text-blue-800 mr-4">Sửa</button>
              <button onclick="deleteStock(${s.stockId})" class="text-red-600 hover:text-red-800">Xóa</button>
            </td>
          </tr>`;
        stockTableBody.innerHTML += row;
      });
    }

    // Tìm kiếm
    document.getElementById("filterBtn").addEventListener("click", async () => {
        const keyword = document.getElementById("keyword").value.trim();
        const minQty = document.getElementById("minQty").value || '';
        const maxQty = document.getElementById("maxQty").value || '';
        try {
            const res = await fetch(`${apiBase}/search?keyword=${keyword}&minQty=${minQty}&maxQty=${maxQty}`, { headers });
            if (!res.ok) throw new Error('Tìm kiếm thất bại.');
            const filteredStocks = await res.json();
            renderStocks(filteredStocks);
        } catch (error) {
            showFeedback(error.message, true);
        }
    });

    // Modal
    const stockModal = document.getElementById("stockModal");
    function showModal() { stockModal.dataset.state = 'open'; }
    function closeModal() {
        stockModal.dataset.state = 'closing';
        setTimeout(() => { stockModal.dataset.state = 'closed'; }, 200);
    }
    
    document.getElementById("addStockBtn").onclick = () => openAddModal();
    document.getElementById("cancelStock").onclick = () => closeModal();

    function openAddModal() {
      editingId = null;
      document.getElementById("modalTitle").innerText = "Thêm tồn kho mới";
      document.getElementById("quantity").value = "";
      drugSelect.disabled = false;
      loadDrugs();
      showModal();
    }

    async function openEditModal(id) {
        try {
            const res = await fetch(`${apiBase}/${id}`, { headers });
            if (!res.ok) throw new Error('Không thể lấy thông tin chi tiết.');
            const s = await res.json();
            editingId = id;
            document.getElementById("modalTitle").innerText = "Sửa thông tin tồn kho";
            document.getElementById("quantity").value = s.quantityAvailable;
            await loadDrugs();
            drugSelect.value = s.drugId;
            drugSelect.disabled = true;
            showModal();
        } catch (error) {
            alert(error.message);
        }
    }

    // Lưu
    document.getElementById("saveStock").onclick = async () => {
      const stock = {
        drugId: parseInt(drugSelect.value),
        quantityAvailable: parseInt(document.getElementById("quantity").value)
      };

      if (isNaN(stock.drugId) || isNaN(stock.quantityAvailable)) {
        alert("Vui lòng chọn thuốc và nhập số lượng tồn hợp lệ.");
        return;
      }

      const url = editingId ? `${apiBase}/${editingId}` : apiBase;
      const method = editingId ? "PUT" : "POST";
      
      try {
        const res = await fetch(url, { method, headers, body: JSON.stringify(stock) });
        if (!res.ok) throw new Error("Thao tác thất bại.");
        alert(editingId ? "Cập nhật thành công!" : "Thêm thành công!");
        closeModal();
        loadStocks();
      } catch (error) {
        alert("Lỗi: " + error.message);
      }
    };

    // Xóa
    async function deleteStock(id) {
      if (!confirm("Bạn có chắc muốn xóa bản ghi tồn kho này?")) return;
      try {
        const res = await fetch(`${apiBase}/${id}`, { method: "DELETE", headers });
        if (!res.ok) throw new Error("Không thể xóa bản ghi.");
        alert("Đã xóa thành công!");
        loadStocks();
      } catch (error) {
        alert(error.message);
      }
    }
  </script>
</body>
</html>
