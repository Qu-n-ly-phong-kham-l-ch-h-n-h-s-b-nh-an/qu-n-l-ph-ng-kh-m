<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Qu·∫£n l√Ω T√†i kho·∫£n</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <style>
    body { font-family: 'Inter', sans-serif; }
    .btn { padding: 0.5rem 1rem; border-radius: 0.375rem; color: white; font-weight: 600; transition: background-color 0.2s; cursor: pointer; }
    .btn-blue { background-color: #2563eb; }
    .btn-blue:hover { background-color: #1d4ed8; }
    .btn-green { background-color: #16a34a; }
    .btn-green:hover { background-color: #15803d; }
    .btn-red { background-color: #dc2626; }
    .btn-red:hover { background-color: #b91c1c; }
    .btn-gray { background-color: #6b7280; }
    .btn-gray:hover { background-color: #4b5563; }
    .btn:disabled { background-color: #9ca3af; cursor: not-allowed; opacity: 0.7; }
    .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); justify-content: center; align-items: center; z-index: 50; }
    .modal.flex { display: flex; }
  </style>
</head>

<body class="bg-gray-100 p-6 min-h-screen">
  <div class="max-w-7xl mx-auto bg-white p-8 rounded-xl shadow-lg">
    <div class="flex justify-between items-center mb-6 border-b pb-4">
        <h1 class="text-3xl font-bold text-blue-700">üë• Qu·∫£n l√Ω T√†i kho·∫£n</h1>
        <button id="addAccountBtn" class="btn btn-green">+ Th√™m t√†i kho·∫£n m·ªõi</button>
    </div>

    <div class="overflow-x-auto border rounded-lg">
      <table class="min-w-full">
        <thead class="bg-gray-50 text-left">
          <tr>
            <th class="p-3 font-semibold text-gray-600">ID</th>
            <th class="p-3 font-semibold text-gray-600">T√™n ƒëƒÉng nh·∫≠p</th>
            <th class="p-3 font-semibold text-gray-600">Quy·ªÅn</th>
            <th class="p-3 font-semibold text-gray-600">Tr·∫°ng th√°i</th>
            <th class="p-3 font-semibold text-gray-600 text-center">H√†nh ƒë·ªông</th>
          </tr>
        </thead>
        <tbody class="divide-y" id="accountBody"></tbody>
      </table>
    </div>
  </div>

  <div id="accountModal" class="modal">
    <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-md">
      <h2 id="modalTitle" class="text-xl font-bold mb-4 text-blue-700">Th√™m t√†i kho·∫£n</h2>
      <form id="accountForm" class="flex flex-col gap-4">
        <input type="hidden" id="accountId">
        <div>
            <label for="username" class="block text-sm font-medium text-gray-700">T√™n ƒëƒÉng nh·∫≠p</label>
            <input type="text" id="username" class="border p-2 rounded w-full mt-1" required>
        </div>
        <div>
            <label for="password" class="block text-sm font-medium text-gray-700">M·∫≠t kh·∫©u</label>
            <input type="password" id="password" placeholder="ƒê·ªÉ tr·ªëng n·∫øu kh√¥ng mu·ªën ƒë·ªïi" class="border p-2 rounded w-full mt-1">
        </div>
        <div>
            <label for="role" class="block text-sm font-medium text-gray-700">Quy·ªÅn</label>
            <select id="role" class="border p-2 rounded w-full mt-1" required>
                <option value="Admin">Admin</option>
                <option value="Doctor">Doctor</option>
                <option value="Receptionist">Receptionist</option>
                <option value="Patient">Patient</option>
            </select>
        </div>
        <div>
            <label for="isActive" class="block text-sm font-medium text-gray-700">Tr·∫°ng th√°i</label>
            <select id="isActive" class="border p-2 rounded w-full mt-1" required>
                <option value="true">Ho·∫°t ƒë·ªông</option>
                <option value="false">Kh√≥a</option>
            </select>
        </div>
        <div class="flex justify-end gap-3 mt-4">
          <button type="button" id="cancelModal" class="btn btn-gray">H·ªßy</button>
          <button type="submit" class="btn btn-green">L∆∞u</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const apiBase = "http://localhost:5236/api";
    const token = localStorage.getItem("token");
    const headers = { "Authorization": `Bearer ${token}`, "Content-Type": "application/json" };
    let editingId = null;

    const modal = document.getElementById("accountModal");
    const form = document.getElementById("accountForm");

    async function loadAccounts() {
        try {
            const res = await fetch(`${apiBase}/Accounts`, { headers });
            if (!res.ok) throw new Error("T·∫£i danh s√°ch t√†i kho·∫£n th·∫•t b·∫°i.");
            const accounts = await res.json();
            renderTable(accounts);
        } catch (error) {
            console.error(error);
            alert(error.message);
        }
    }

    async function saveAccount(e) {
        e.preventDefault();
        const password = document.getElementById("password").value;
        const data = {
            accountId: editingId ? parseInt(editingId) : 0,
            username: document.getElementById("username").value,
            password: password, // G·ª≠i m·∫≠t kh·∫©u plain text, backend s·∫Ω m√£ h√≥a
            role: document.getElementById("role").value,
            isActive: document.getElementById("isActive").value === 'true',
        };

        // Khi t·∫°o m·ªõi, m·∫≠t kh·∫©u l√† b·∫Øt bu·ªôc
        if (!editingId && !password) {
            alert("Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u khi t·∫°o t√†i kho·∫£n m·ªõi.");
            return;
        }

        const method = editingId ? "PUT" : "POST";
        const url = editingId ? `${apiBase}/Accounts/${editingId}` : `${apiBase}/Accounts`;

        try {
            const res = await fetch(url, { method, headers, body: JSON.stringify(data) });
            if (!res.ok) {
                const errorData = await res.json();
                throw new Error(errorData.message || "L∆∞u th·∫•t b·∫°i.");
            }
            alert(`ƒê√£ ${editingId ? 'c·∫≠p nh·∫≠t' : 'th√™m'} t√†i kho·∫£n th√†nh c√¥ng!`);
            closeModal();
            loadAccounts();
        } catch (error) {
            console.error(error);
            alert(error.message);
        }
    }
    
    async function deleteAccount(id) {
        if (!confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a t√†i kho·∫£n ID #${id}?`)) return;
        try {
            const res = await fetch(`${apiBase}/Accounts/${id}`, { method: 'DELETE', headers });
            if (!res.ok) {
                const errorData = await res.json();
                throw new Error(errorData.message || "X√≥a th·∫•t b·∫°i.");
            }
            alert("ƒê√£ x√≥a t√†i kho·∫£n th√†nh c√¥ng!");
            loadAccounts();
        } catch (error) {
            console.error(error);
            alert(error.message);
        }
    }

    function renderTable(accounts) {
        const tbody = document.getElementById("accountBody");
        tbody.innerHTML = accounts.map(acc => `
            <tr class="hover:bg-gray-50">
                <td class="p-3 border-b">${acc.accountId}</td>
                <td class="p-3 border-b">${acc.username}</td>
                <td class="p-3 border-b">${acc.role}</td>
                <td class="p-3 border-b">${acc.isActive ? '<span class="text-green-600 font-semibold">Ho·∫°t ƒë·ªông</span>' : '<span class="text-red-600 font-semibold">Kh√≥a</span>'}</td>
                <td class="p-3 border-b text-center">
                    <button class="btn btn-blue text-xs" onclick='openEditModal(${JSON.stringify(acc)})'>C·∫≠p nh·∫≠t</button>
                    <button class="btn btn-red text-xs" onclick='deleteAccount(${acc.accountId})'>X√≥a</button>
                </td>
            </tr>
        `).join('');
    }

    function openAddModal() {
        editingId = null;
        form.reset();
        document.getElementById("username").disabled = false;
        document.getElementById("password").placeholder = "Nh·∫≠p m·∫≠t kh·∫©u...";
        document.getElementById("modalTitle").textContent = "Th√™m t√†i kho·∫£n m·ªõi";
        modal.classList.add("flex");
    }

    function openEditModal(account) {
        editingId = account.accountId;
        form.reset();
        document.getElementById("accountId").value = account.accountId;
        document.getElementById("username").value = account.username;
        document.getElementById("username").disabled = true; // Kh√¥ng cho ph√©p s·ª≠a username
        document.getElementById("role").value = account.role;
        document.getElementById("isActive").value = account.isActive;
        document.getElementById("password").placeholder = "ƒê·ªÉ tr·ªëng n·∫øu kh√¥ng mu·ªën ƒë·ªïi";
        document.getElementById("modalTitle").textContent = `C·∫≠p nh·∫≠t t√†i kho·∫£n: ${account.username}`;
        modal.classList.add("flex");
    }

    function closeModal() {
        modal.classList.remove("flex");
    }

    document.getElementById("addAccountBtn").onclick = openAddModal;
    document.getElementById("cancelModal").onclick = closeModal;
    form.onsubmit = saveAccount;

    document.addEventListener('DOMContentLoaded', loadAccounts);
  </script>
</body>
</html>