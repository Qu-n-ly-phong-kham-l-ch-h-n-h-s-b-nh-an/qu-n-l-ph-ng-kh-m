<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Quản lý Bệnh nhân - Admin</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Inter', sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: #f1f5f9; }
    ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 10px; }
    ::-webkit-scrollbar-thumb:hover { background: #64748b; }
    
    .clickable-row {
        cursor: pointer;
    }
  </style>
</head>

<body class="bg-slate-100 text-slate-800">

  <div class="container mx-auto p-4 sm:p-6 lg:p-8">
    <div class="max-w-7xl mx-auto bg-white p-6 sm:p-8 rounded-2xl shadow-lg">
      
      <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-6 pb-4 border-b border-slate-200">
        <div class="flex items-center gap-3 mb-4 sm:mb-0">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
          </svg>
          <h1 class="text-2xl sm:text-3xl font-bold text-slate-800">Quản lý Bệnh nhân</h1>
        </div>
        <button id="addBtn" class="w-full sm:w-auto flex items-center justify-center gap-2 bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition-all">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
          </svg>
          <span>Thêm mới</span>
        </button>
      </div>

      <div class="flex items-center gap-3 mb-6">
        <div class="relative flex-grow">
          <span class="absolute inset-y-0 left-0 flex items-center pl-3">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-slate-400" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
            </svg>
          </span>
          <input id="searchKeyword" type="text" placeholder="Tìm kiếm theo tên hoặc số điện thoại..." class="w-full pl-10 pr-4 py-2 border border-slate-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition-colors" />
        </div>
        <button id="searchBtn" class="bg-slate-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-slate-800 focus:outline-none focus:ring-2 focus:ring-slate-500 focus:ring-offset-2 transition-colors">Tìm kiếm</button>
      </div>

      <div class="overflow-x-auto rounded-lg border border-slate-200">
        <table class="min-w-full divide-y divide-slate-200">
          <thead class="bg-slate-50">
            <tr>
              <th scope="col" class="p-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">ID</th>
              <th scope="col" class="p-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Họ và tên</th>
              <th scope="col" class="p-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Ngày sinh</th>
              <th scope="col" class="p-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Giới tính</th>
              <th scope="col" class="p-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">SĐT</th>
              <th scope="col" class="p-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Email</th>
              <th scope="col" class="p-4 text-center text-xs font-semibold text-slate-500 uppercase tracking-wider">Hành động</th>
            </tr>
          </thead>
          <tbody id="patientTable" class="bg-white divide-y divide-slate-200">
            </tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="patientModal" class="fixed inset-0 bg-black/60 hidden items-center justify-center p-4 transition-opacity duration-300 opacity-0">
    <div class="bg-white p-6 sm:p-8 rounded-2xl w-full max-w-lg shadow-xl transform transition-all duration-300 scale-95">
      <div class="flex items-center justify-between pb-3 border-b border-slate-200">
        <h2 id="modalTitle" class="text-xl font-bold text-slate-800"></h2>
        <button id="closePatientModalBtn" class="text-slate-400 hover:text-slate-600">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
        </button>
      </div>
      <div class="mt-6 space-y-4">
        <div><label for="patientName" class="block text-sm font-medium text-slate-700 mb-1">Họ và tên</label><input id="patientName" type="text" placeholder="Nhập họ và tên..." class="w-full border-slate-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500" /></div>
        <div><label for="patientBirth" class="block text-sm font-medium text-slate-700 mb-1">Ngày sinh</label><input id="patientBirth" type="date" class="w-full border-slate-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500" /></div>
        <div><label for="patientGender" class="block text-sm font-medium text-slate-700 mb-1">Giới tính</label><select id="patientGender" class="w-full border-slate-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500"><option value="">-- Chọn giới tính --</option><option value="Nam">Nam</option><option value="Nữ">Nữ</option></select></div>
        <div><label for="patientPhone" class="block text-sm font-medium text-slate-700 mb-1">Số điện thoại</label><input id="patientPhone" type="text" placeholder="Nhập số điện thoại..." class="w-full border-slate-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500" /></div>
        <div><label for="patientEmail" class="block text-sm font-medium text-slate-700 mb-1">Email</label><input id="patientEmail" type="email" placeholder="Nhập địa chỉ email..." class="w-full border-slate-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500" /></div>
      </div>
      <div class="flex justify-end gap-3 mt-8 pt-4 border-t border-slate-200">
        <button id="cancelPatient" class="bg-slate-200 text-slate-700 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300">Hủy</button>
        <button id="savePatient" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700">Lưu</button>
      </div>
    </div>
  </div>

  <div id="prescriptionModal" class="fixed inset-0 bg-black/60 hidden items-center justify-center p-4 transition-opacity duration-300 opacity-0">
    <div class="bg-white p-6 sm:p-8 rounded-2xl w-full max-w-3xl shadow-xl transform transition-all duration-300 scale-95">
      <div class="flex items-center justify-between pb-3 border-b border-slate-200">
        <h2 id="prescriptionModalTitle" class="text-xl font-bold text-slate-800"></h2>
        <button id="closePrescriptionModalBtn" class="text-slate-400 hover:text-slate-600">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
        </button>
      </div>
      <div class="mt-4 overflow-y-auto max-h-[60vh]">
        <table class="min-w-full divide-y divide-slate-200">
          <thead class="bg-slate-50 sticky top-0">
            <tr>
              <th class="p-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">ID Đơn</th>
              <th class="p-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Tên thuốc</th>
              <th class="p-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Số lượng</th>
              <th class="p-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Cách dùng</th>
            </tr>
          </thead>
          <tbody id="prescriptionTableBody" class="bg-white divide-y divide-slate-200">
            </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    const apiBase = "http://localhost:5236/api";
    const token = localStorage.getItem("token");
    let allPatients = [];
    let editingId = null;

    if (!token) {
      alert("Vui lòng đăng nhập trước!");
      window.location.href = "../Login/login.html?role=Admin";
    }

    const headers = { "Authorization": `Bearer ${token}`, "Content-Type": "application/json" };
    
    window.onload = () => {
      loadPatients();
      setupEventListeners();
    };

    async function loadPatients() {
      try {
        const res = await fetch(`${apiBase}/Patients`, { headers });
        if (!res.ok) throw new Error('Không thể tải dữ liệu bệnh nhân');
        allPatients = await res.json();
        renderPatients(allPatients);
      } catch (error) {
        console.error("Lỗi tải bệnh nhân:", error);
        document.getElementById("patientTable").innerHTML = `<tr><td colspan="7" class="p-4 text-center text-slate-500">Không thể tải dữ liệu. Vui lòng thử lại.</td></tr>`;
      }
    }

    function renderPatients(patientsToRender) {
      const tbody = document.getElementById("patientTable");
      tbody.innerHTML = "";
      if (patientsToRender.length === 0) {
        tbody.innerHTML = `<tr><td colspan="7" class="p-4 text-center text-slate-500">Không tìm thấy bệnh nhân nào.</td></tr>`;
        return;
      }
      
      patientsToRender.forEach(p => {
        const row = document.createElement('tr');
        row.className = 'hover:bg-slate-50 transition-colors clickable-row';
        const safeFullName = p.fullName.replace(/'/g, "\\'");
        
        // <<< THAY ĐỔI >>>: Gọi hàm showPrescriptions thay vì showDiagnoses
        row.setAttribute('onclick', `showPrescriptions(${p.patientId}, '${safeFullName}')`);

        row.innerHTML = `
          <td class="p-4 whitespace-nowrap text-sm font-medium text-slate-900">${p.patientId}</td>
          <td class="p-4 whitespace-nowrap text-sm text-slate-600">${p.fullName}</td>
          <td class="p-4 whitespace-nowrap text-sm text-slate-600">${p.dob ? new Date(p.dob).toLocaleDateString('vi-VN') : "N/A"}</td>
          <td class="p-4 whitespace-nowrap text-sm text-slate-600">${p.gender || "N/A"}</td>
          <td class="p-4 whitespace-nowrap text-sm text-slate-600">${p.phone || "N/A"}</td>
          <td class="p-4 whitespace-nowrap text-sm text-slate-600">${p.email || "N/A"}</td>
          <td class="p-4 whitespace-nowrap text-sm font-medium text-center">
            <button onclick="event.stopPropagation(); editPatient(${p.patientId})" class="text-indigo-600 hover:text-indigo-900 font-semibold mr-3">Sửa</button>
            <button onclick="event.stopPropagation(); deletePatient(${p.patientId})" class="text-rose-600 hover:text-rose-900 font-semibold">Xóa</button>
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    function setupEventListeners() {
      document.getElementById("searchBtn").addEventListener("click", handleSearch);
      document.getElementById("searchKeyword").addEventListener("keyup", (e) => { if (e.key === "Enter") handleSearch(); });
      
      // Modal bệnh nhân
      document.getElementById("addBtn").onclick = openAddPatientModal;
      document.getElementById("savePatient").onclick = savePatient;
      document.getElementById("cancelPatient").onclick = closePatientModal;
      document.getElementById("closePatientModalBtn").onclick = closePatientModal;
      document.getElementById("patientModal").onclick = (e) => { if (e.target.id === "patientModal") closePatientModal(); };

      // <<< THAY ĐỔI >>>: Gán sự kiện cho modal đơn thuốc
      document.getElementById("closePrescriptionModalBtn").onclick = closePrescriptionModal;
      document.getElementById("prescriptionModal").onclick = (e) => { if (e.target.id === "prescriptionModal") closePrescriptionModal(); };
    }
    
    function handleSearch() {
      const keyword = document.getElementById("searchKeyword").value.trim().toLowerCase();
      const filtered = keyword ? allPatients.filter(p => p.fullName.toLowerCase().includes(keyword) || (p.phone && p.phone.includes(keyword))) : allPatients;
      renderPatients(filtered);
    }

    function openModal(modal) {
      modal.classList.remove("hidden");
      setTimeout(() => {
        modal.classList.remove("opacity-0");
        modal.querySelector('div > div').classList.remove('scale-95');
      }, 10);
    }
    
    function closeModal(modal) {
      modal.classList.add("opacity-0");
      modal.querySelector('div > div').classList.add('scale-95');
      setTimeout(() => modal.classList.add("hidden"), 300);
    }

    // <<< THAY ĐỔI >>>: Toàn bộ hàm này được viết lại để hiển thị đơn thuốc
    const prescriptionModal = document.getElementById("prescriptionModal");
    function closePrescriptionModal() { closeModal(prescriptionModal); }

    async function showPrescriptions(patientId, patientName) {
        document.getElementById("prescriptionModalTitle").innerText = `Đơn thuốc của bệnh nhân: ${patientName}`;
        const tbody = document.getElementById("prescriptionTableBody");
        tbody.innerHTML = `<tr><td colspan="4" class="p-4 text-center text-slate-500">Đang tải dữ liệu...</td></tr>`;
        openModal(prescriptionModal);

        try {
            // !!! QUAN TRỌNG: API endpoint này cần được tạo ở backend
            // Nó nên trả về một danh sách các đơn thuốc của bệnh nhân có ID tương ứng.
            const res = await fetch(`${apiBase}/Patients/${patientId}/prescriptions`, { headers });
            if (!res.ok) throw new Error('Không thể tải danh sách đơn thuốc.');
            const prescriptions = await res.json();

            if (prescriptions.length === 0) {
                tbody.innerHTML = `<tr><td colspan="4" class="p-4 text-center text-slate-500">Bệnh nhân này chưa có đơn thuốc nào.</td></tr>`;
                return;
            }

            tbody.innerHTML = "";
            // Giả sử API trả về mảng object có dạng: { prescriptionId, drugName, quantity, usage }
            prescriptions.forEach(p => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="p-3 text-sm font-medium text-slate-700">${p.prescriptionId}</td>
                    <td class="p-3 text-sm text-slate-600">${p.drugName || 'N/A'}</td>
                    <td class="p-3 text-sm text-slate-600">${p.quantity || 'N/A'}</td>
                    <td class="p-3 text-sm text-slate-600">${p.usage || ''}</td>
                `;
                tbody.appendChild(row);
            });
        } catch (error) {
            console.error("Lỗi tải đơn thuốc:", error);
            tbody.innerHTML = `<tr><td colspan="4" class="p-4 text-center text-red-500">Lỗi: ${error.message}</td></tr>`;
        }
    }

    // --- CRUD BỆNH NHÂN (Không thay đổi) ---
    const patientModal = document.getElementById("patientModal");
    function closePatientModal() { closeModal(patientModal); }
    
    function openAddPatientModal() {
      editingId = null;
      document.getElementById("modalTitle").textContent = "Thêm bệnh nhân mới";
      document.querySelectorAll("#patientModal input, #patientModal select").forEach(i => i.value = "");
      openModal(patientModal);
    }

    async function editPatient(id) {
        try {
            const res = await fetch(`${apiBase}/Patients/${id}`, { headers });
            if (!res.ok) throw new Error('Không tìm thấy bệnh nhân');
            const p = await res.json();
            
            editingId = id;
            document.getElementById("modalTitle").textContent = "Chỉnh sửa thông tin bệnh nhân";
            document.getElementById("patientName").value = p.fullName || '';
            document.getElementById("patientBirth").value = p.dob ? p.dob.split("T")[0] : '';
            document.getElementById("patientGender").value = p.gender || '';
            document.getElementById("patientPhone").value = p.phone || '';
            document.getElementById("patientEmail").value = p.email || '';
            
            openModal(patientModal);
        } catch(error) {
            alert(error.message);
        }
    }

    async function savePatient() {
      const patientData = {
        fullName: document.getElementById("patientName").value.trim(),
        dob: document.getElementById("patientBirth").value,
        gender: document.getElementById("patientGender").value,
        phone: document.getElementById("patientPhone").value.trim(),
        email: document.getElementById("patientEmail").value.trim()
      };
      
      if(!patientData.fullName) { alert("Vui lòng nhập họ và tên."); return; }

      const method = editingId ? "PUT" : "POST";
      const url = editingId ? `${apiBase}/Patients/${editingId}` : `${apiBase}/Patients`;

      try {
        const res = await fetch(url, { method, headers, body: JSON.stringify(patientData) });
        if (!res.ok) throw new Error('Thao tác thất bại');
        alert(editingId ? "Cập nhật thành công!" : "Thêm mới thành công!");
        closePatientModal();
        loadPatients();
      } catch (error) {
        alert(`Lỗi: ${error.message}`);
      }
    }

    async function deletePatient(id) {
      if (!confirm("Bạn có chắc chắn muốn xóa bệnh nhân này?")) return;
      
      try {
        const res = await fetch(`${apiBase}/Patients/${id}`, { method: "DELETE", headers });
        if (!res.ok) throw new Error('Không thể xóa bệnh nhân');
        alert("Đã xóa bệnh nhân thành công!");
        loadPatients();
      } catch (error) {
        alert(error.message);
      }
    }
  </script>
</body>
</html>